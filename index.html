<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Nutrition Barcode Scanner</title>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    button { padding: 10px 15px; margin: 10px 0; cursor: pointer; }
    #reader { width: 300px; margin: 20px auto; border: 2px solid #ccc; background: #fff; }
    .card { background: #fff; padding: 15px; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>Nutrition Barcode Scanner</h1>
  <button onclick="startScanner()">Start Scan</button>
  <div id="reader"></div>

  <div id="result" class="card" style="display:none;">
    <h2 id="product-name"></h2>
    <p><strong>Calories:</strong> <span id="product-calories"></span></p>
    <p><strong>Serving Size:</strong> <span id="product-serving"></span></p>
    <p><strong>Protein:</strong> <span id="product-protein"></span> g</p>
    <p><strong>Fat:</strong> <span id="product-fat"></span> g</p>
    <p><strong>Carbs:</strong> <span id="product-carbs"></span> g</p>
    <p><strong>Sugar:</strong> <span id="product-sugar"></span> g</p>
    <p><strong>Sodium:</strong> <span id="product-sodium"></span> mg</p>
  </div>

<script>
let scanner = null;
let customBarcodes = [];

// Load custom barcodes from Google Sheets
async function loadCustomBarcodes() {
  const SPREADSHEET_ID = "1E6_ttym28kV8Zmhgp6IZTbBU-JW2nMsHmMLF3nelwKk";
  const API_KEY = "AIzaSyA_RFv8OEtfltOrt3wEsI4wojid5o6x79A";
  const RANGE = "Sheet1!A2:I";

  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (!data.values) return;

    customBarcodes = data.values.map(row => ({
      barcode: (row[0] || "").padStart(12, "0"),
      name: row[1] || "Unknown",
      calories: Number(row[2]) || 0,
      serving: row[3] || "?",
      nutrition: {
        protein: Number(row[4]) || 0,
        fat: Number(row[5]) || 0,
        carbs: Number(row[6]) || 0,
        sugar: Number(row[7]) || 0,
        sodium: Number(row[8]) || 0
      }
    }));
    console.log("Loaded barcodes:", customBarcodes);
  } catch (err) {
    console.error("Error loading barcodes:", err);
  }
}

// Start scanner
async function startScanner() {
  try {
    if (scanner) {
      await scanner.stop().catch(()=>{});
      scanner = null;
    }

    scanner = new Html5Qrcode("reader");
    const cameras = await Html5Qrcode.getCameras();
    if (!cameras || cameras.length === 0) {
      alert("No camera found.");
      return;
    }

    const camId = cameras.find(c => c.label.toLowerCase().includes("back"))?.id || cameras[0].id;

    await scanner.start(
      camId,
      { fps: 10, qrbox: { width: 250, height: 250 } },
      async (decodedText) => {
        console.log("Scanned:", decodedText);
        await scanner.stop();
        scanner = null;
        fetchProduct(decodedText);
      },
      (err) => { console.log("Scan error:", err); }
    );

  } catch (err) {
    console.error("Camera error:", err);
    alert("Camera error: " + err.message);
  }
}

// Find product from custom list
function fetchProduct(barcode) {
  const product = customBarcodes.find(p => p.barcode === barcode);
  if (product) {
    displayProduct(product);
  } else {
    alert("Product not found in database.");
  }
}

// Display product info
function displayProduct(product) {
  document.getElementById("result").style.display = "block";
  document.getElementById("product-name").textContent = product.name;
  document.getElementById("product-calories").textContent = product.calories;
  document.getElementById("product-serving").textContent = product.serving;
  document.getElementById("product-protein").textContent = product.nutrition.protein;
  document.getElementById("product-fat").textContent = product.nutrition.fat;
  document.getElementById("product-carbs").textContent = product.nutrition.carbs;
  document.getElementById("product-sugar").textContent = product.nutrition.sugar;
  document.getElementById("product-sodium").textContent = product.nutrition.sodium;
}

// Load custom barcodes on page load
window.onload = loadCustomBarcodes;
</script>
</body>
</html>
