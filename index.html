<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nutrue</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #121212;
      color: #eee;
      text-align: center;
    }
    h1 { margin-bottom: 0.5rem; }
    video {
      width: 100%;
      max-height: 250px;
      border-radius: 12px;
      background: #000;
      margin: 1rem 0;
    }
    button {
      padding: 0.75rem 1.2rem;
      margin: 0.5rem;
      border: none;
      border-radius: 12px;
      background: #2a9d8f;
      color: white;
      font-size: 1rem;
    }
    button:active { opacity: 0.8; }
    .card {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 12px;
      margin-top: 1rem;
      text-align: left;
    }
    .nutrient {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
  </style>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
</head>
<body>
  <h1>Nutrue</h1>
  <p>Scan a barcode to get nutrition info</p>
  
  <video id="preview"></video>
  <button onclick="startScanner()">Start Scan</button>
  <button onclick="stopScanner()">Stop Scan</button>
  
  <div id="result"></div>

  <script>
    let codeReader, stream;

    async function startScanner() {
      codeReader = new ZXing.BrowserMultiFormatReader();
      try {
        const previewElem = document.getElementById('preview');
        await codeReader.decodeFromVideoDevice({ facingMode: "environment" }, previewElem, (result, err) => {
          if (result) {
            stopScanner();
            fetchProduct(result.text);
          }
        });
      } catch (e) {
        alert("Camera error: " + e);
      }
    }

    function stopScanner() {
      if (codeReader) codeReader.reset();
    }

    async function fetchProduct(barcode) {
      const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
      const data = await res.json();
      if (data.status === 1) {
        showProduct(data.product);
      } else {
        document.getElementById("result").innerHTML = "<p>Not found. Add manually later.</p>";
      }
    }

    function showProduct(p) {
      const nutrients = p.nutriments || {};
      const fields = [
        ["Energy (kcal)", nutrients["energy-kcal_100"]],
        ["Protein", nutrients.proteins_100 + " g"],
        ["Carbs", nutrients.carbohydrates_100 + " g"],
        ["Sugar", nutrients.sugars_100 + " g"],
        ["Fat", nutrients.fat_100 + " g"],
        ["Saturated", nutrients["saturated-fat_100"] + " g"],
        ["Fiber", nutrients.fiber_100 + " g"],
        ["Sodium", nutrients.sodium_100 + " g"]
      ];
      let html = `<div class="card"><h2>${p.product_name || "Unknown Product"}</h2>`;
      fields.forEach(([label, val]) => {
        if (val && val !== "undefined g") {
          html += `<div class="nutrient"><span>${label}</span><span>${val}</span></div>`;
        }
      });
      html += `<button onclick="copyToClipboard('${p.product_name}: ${nutrients['energy-kcal_100']} kcal, ${nutrients.proteins_100}g P, ${nutrients.carbohydrates_100}g C, ${nutrients.fat_100}g F')">Copy for MyFitnessPal</button>`;
      html += "</div>";
      document.getElementById("result").innerHTML = html;
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
        alert("Copied to clipboard!");
      } else {
        prompt("Copy this:", text);
      }
    }
  </script>
</body>
</html>
