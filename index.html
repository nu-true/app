<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Barcode Nutrition Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    #reader { width: 100%; max-width: 400px; margin: auto; }
    .card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .success { border-left: 5px solid green; }
    .error { border-left: 5px solid red; }
    button { padding: 10px 15px; margin: 10px 0; border: none; border-radius: 5px; cursor: pointer; background: #007bff; color: white; }
    button:disabled { background: #ccc; }
  </style>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
  <h2>Barcode Nutrition Scanner</h2>
  <button onclick="startScanner()">Start Scan</button>
  <div id="reader"></div>
  <div id="result"></div>

  <script>
    const SPREADSHEET_ID = "YOUR_SHEET_ID"; 
    const RANGE = "Sheet1!A2:G"; 
    const API_KEY = "YOUR_API_KEY";

    async function fetchSheetData() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.values) throw new Error("No data found in sheet");
        return data.values.map(row => ({
          barcode: (row[0] || "").padStart(12, "0"),
          name: row[1] || "Unknown",
          serving: row[2] || "N/A",
          calories: row[3] || "N/A",
          fat: row[4] || "N/A",
          carbs: row[5] || "N/A",
          protein: row[6] || "N/A",
        }));
      } catch (err) {
        console.error("Fetch error:", err);
        return [];
      }
    }

    let html5QrcodeScanner;

    async function startScanner() {
      const readerDiv = document.getElementById("reader");
      if (html5QrcodeScanner) {
        await html5QrcodeScanner.stop().catch(()=>{});
        readerDiv.innerHTML = ""; // reset
      }

      html5QrcodeScanner = new Html5Qrcode("reader");

      try {
        await html5QrcodeScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          async (decodedText) => {
            const sheetData = await fetchSheetData();
            const product = sheetData.find(p => p.barcode === decodedText);

            const card = document.createElement("div");
            card.className = "card " + (product ? "success" : "error");
            card.innerHTML = product
              ? `<h3>${product.name}</h3>
                 <p><strong>Serving:</strong> ${product.serving}</p>
                 <p><strong>Calories:</strong> ${product.calories}</p>
                 <p><strong>Fat:</strong> ${product.fat}</p>
                 <p><strong>Carbs:</strong> ${product.carbs}</p>
                 <p><strong>Protein:</strong> ${product.protein}</p>`
              : `<h3>Product not found</h3><p>Barcode: ${decodedText}</p>`;

            const resultBox = document.getElementById("result");
            resultBox.insertBefore(card, resultBox.firstChild);
          }
        );
      } catch (err) {
        console.error("Camera start failed:", err);
        alert("Could not start camera. Please check permissions.");
      }
    }
  </script>
</body>
</html>
